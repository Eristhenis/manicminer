<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Manic Miner: Routine at 36707</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="36593.html">36593</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#36707">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="36805.html">36805</a></span></td>
</tr>
</table>
<div class="description">36707: Draw the items in the current cavern and collect any that Willy is touching</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="34574.html">34574</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="36707"></a>36707</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="2">Initialise the attribute of the last item drawn at <a class="link" href="32884.html">32884</a> to 0 (in case there are no items left to draw)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36708"></a>36708</td>
<td class="instruction">LD (32884),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36711"></a>36711</td>
<td class="instruction">LD IY,32885</td>
<td class="comment-11" rowspan="1">Point <span class="register">IY</span> at the first byte of the first item definition at <a class="link" href="32885.html">32885</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="36715"></a>
<div class="comments">
<div class="paragraph">
The item-drawing loop begins here.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="36715"></a>36715</td>
<td class="instruction">LD A,(IY+0)</td>
<td class="comment-11" rowspan="1">Pick up the first byte of the item definition</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36718"></a>36718</td>
<td class="instruction">CP 255</td>
<td class="comment-11" rowspan="1">Have we dealt with all the items yet?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36720"></a>36720</td>
<td class="instruction">JR Z,<a class="link" href="36707.html#36794">36794</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36722"></a>36722</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">Has this item already been collected?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36723"></a>36723</td>
<td class="instruction">JR Z,<a class="link" href="36707.html#36782">36782</a></td>
<td class="comment-11" rowspan="1">If so, skip it and consider the next one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36725"></a>36725</td>
<td class="instruction">LD E,(IY+1)</td>
<td class="comment-11" rowspan="2">Point <span class="register">DE</span> at the address of the item's location in the attribute buffer at <a class="link" href="23552.html">23552</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36728"></a>36728</td>
<td class="instruction">LD D,(IY+2)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36731"></a>36731</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up the current attribute byte at the item's location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36732"></a>36732</td>
<td class="instruction">AND 7</td>
<td class="comment-11" rowspan="2">Is the INK white (which happens if Willy is touching the item)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36734"></a>36734</td>
<td class="instruction">CP 7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36736"></a>36736</td>
<td class="instruction">JR NZ,<a class="link" href="36707.html#36750">36750</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="36738"></a>
<div class="comments">
<div class="paragraph">
Willy is touching this item, so add it to his collection.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36738"></a>36738</td>
<td class="instruction">LD HL,33836</td>
<td class="comment-11" rowspan="2">Add 100 to the score</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36741"></a>36741</td>
<td class="instruction">CALL <a class="link" href="37098.html#37118">37118</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36744"></a>36744</td>
<td class="instruction">LD (IY+0),0</td>
<td class="comment-11" rowspan="1">Set the item's attribute byte to 0 so that it will be skipped the next time</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36748"></a>36748</td>
<td class="instruction">JR <a class="link" href="36707.html#36782">36782</a></td>
<td class="comment-11" rowspan="1">Jump forward to consider the next item</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="36750"></a>
<div class="comments">
<div class="paragraph">
This item has not been collected yet.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="36750"></a>36750</td>
<td class="instruction">LD A,(IY+0)</td>
<td class="comment-11" rowspan="1">Pick up the item's current attribute byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36753"></a>36753</td>
<td class="instruction">AND 248</td>
<td class="comment-11" rowspan="2">Keep the BRIGHT and PAPER bits, and set the INK to 3 (magenta)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36755"></a>36755</td>
<td class="instruction">OR 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36757"></a>36757</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Store this value in <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36758"></a>36758</td>
<td class="instruction">LD A,(IY+0)</td>
<td class="comment-11" rowspan="1">Pick up the item's current attribute byte again</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36761"></a>36761</td>
<td class="instruction">AND 3</td>
<td class="comment-11" rowspan="2">Keep only bits 0 and 1 and add the value in <span class="register">B</span>; this maintains the BRIGHT and PAPER bits, and cycles the INK colour through 3, 4, 5 and 6</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36763"></a>36763</td>
<td class="instruction">ADD A,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36764"></a>36764</td>
<td class="instruction">LD (IY+0),A</td>
<td class="comment-11" rowspan="1">Store the new attribute byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36767"></a>36767</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">Update the attribute byte at the item's location in the buffer at <a class="link" href="23552.html">23552</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36768"></a>36768</td>
<td class="instruction">LD (32884),A</td>
<td class="comment-11" rowspan="1">Store the new attribute byte at <a class="link" href="32884.html">32884</a> as well</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36771"></a>36771</td>
<td class="instruction">LD D,(IY+3)</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the address of the item's location in the screen buffer at <a class="link" href="24576.html">24576</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36774"></a>36774</td>
<td class="instruction">LD HL,32948</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the item graphic for the current cavern (at <a class="link" href="32948.html">32948</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36777"></a>36777</td>
<td class="instruction">LD B,8</td>
<td class="comment-11" rowspan="1">There are eight pixel rows to copy</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36779"></a>36779</td>
<td class="instruction">CALL <a class="link" href="37579.html#37589">37589</a></td>
<td class="comment-11" rowspan="1">Draw the item to the screen buffer at <a class="link" href="24576.html">24576</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="36782"></a>
<div class="comments">
<div class="paragraph">
The current item definition has been dealt with. Time for the next one.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="36782"></a>36782</td>
<td class="instruction">INC IY</td>
<td class="comment-11" rowspan="5">Point <span class="register">IY</span> at the first byte of the next item definition</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36784"></a>36784</td>
<td class="instruction">INC IY</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36786"></a>36786</td>
<td class="instruction">INC IY</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36788"></a>36788</td>
<td class="instruction">INC IY</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36790"></a>36790</td>
<td class="instruction">INC IY</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36792"></a>36792</td>
<td class="instruction">JR <a class="link" href="36707.html#36715">36715</a></td>
<td class="comment-11" rowspan="1">Jump back to deal with the next item</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="36794"></a>
<div class="comments">
<div class="paragraph">
All the items have been dealt with. Check whether there were any left.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="36794"></a>36794</td>
<td class="instruction">LD A,(32884)</td>
<td class="comment-11" rowspan="1">Pick up the attribute of the last item drawn at <a class="link" href="32884.html">32884</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36797"></a>36797</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">Were any items drawn?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36798"></a>36798</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if so (some remain to be collected)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36799"></a>36799</td>
<td class="instruction">LD HL,32911</td>
<td class="comment-11" rowspan="2">Ensure that the portal is flashing by setting bit 7 of its attribute byte at <a class="link" href="32911.html">32911</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36802"></a>36802</td>
<td class="instruction">SET 7,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="36804"></a>36804</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="36593.html">36593</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#36707">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="36805.html">36805</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Manic Miner RAM disassembly 20141004</div>
<div class="copyright">&#169; 1983 Bug-Byte Ltd (Manic Miner). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.1.1.</div>
</div>
</body>
</html>