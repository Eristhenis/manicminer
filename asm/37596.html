<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Manic Miner: Routine at 37596</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="37579.html">37579</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#37596">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="37675.html">37675</a></span></td>
</tr>
</table>
<div class="description">37596: Play the theme tune (The Blue Danube)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="34252.html">34252</a>. Returns with the zero flag reset if ENTER or the fire button is pressed while the tune is being played.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IY</td>
<td class="register-desc"><a class="link" href="33902.html">33902</a> (tune data)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37596"></a>37596</td>
<td class="instruction">LD A,(IY+0)</td>
<td class="comment-11" rowspan="1">Pick up the next byte of tune data from the table at <a class="link" href="33902.html">33902</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37599"></a>37599</td>
<td class="instruction">CP 255</td>
<td class="comment-11" rowspan="1">Has the tune finished?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37601"></a>37601</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return (with the zero flag set) if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37602"></a>37602</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Copy the first byte of data for this note (which determines the duration) to <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37603"></a>37603</td>
<td class="instruction">LD B,0</td>
<td class="comment-11" rowspan="1">Initialise <span class="register">B</span>, which will be used as a delay counter in the note-producing loop</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37605"></a>37605</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Set <span class="register">A</span>=0 (for no apparent reasaon)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37606"></a>37606</td>
<td class="instruction">LD D,(IY+1)</td>
<td class="comment-11" rowspan="1">Pick up the second byte of data for this note</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37609"></a>37609</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1">Copy it to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37610"></a>37610</td>
<td class="instruction">CALL <a class="link" href="37675.html">37675</a></td>
<td class="comment-11" rowspan="1">Calculate the attribute file address for the corresponding piano key</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37613"></a>37613</td>
<td class="instruction">LD (HL),80</td>
<td class="comment-11" rowspan="1">Set the attribute byte for the piano key to 80 (INK 0: PAPER 2: BRIGHT 1)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37615"></a>37615</td>
<td class="instruction">LD E,(IY+2)</td>
<td class="comment-11" rowspan="1">Pick up the third byte of data for this note</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37618"></a>37618</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1">Copy it to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37619"></a>37619</td>
<td class="instruction">CALL <a class="link" href="37675.html">37675</a></td>
<td class="comment-11" rowspan="1">Calculate the attribute file address for the corresponding piano key</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37622"></a>37622</td>
<td class="instruction">LD (HL),40</td>
<td class="comment-11" rowspan="1">Set the attribute byte for the piano key to 40 (INK 0: PAPER 5: BRIGHT 0)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37624"></a>37624</td>
<td class="instruction">OUT (254),A</td>
<td class="comment-11" rowspan="12">Produce a sound based on the frequency parameters in the second and third bytes of data for this note (copied into <span class="register">D</span> and <span class="register">E</span>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37626"></a>37626</td>
<td class="instruction">DEC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37627"></a>37627</td>
<td class="instruction">JR NZ,<a class="link" href="37596.html#37634">37634</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37629"></a>37629</td>
<td class="instruction">LD D,(IY+1)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37632"></a>37632</td>
<td class="instruction">XOR 24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37634"></a>37634</td>
<td class="instruction">DEC E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37635"></a>37635</td>
<td class="instruction">JR NZ,<a class="link" href="37596.html#37642">37642</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37637"></a>37637</td>
<td class="instruction">LD E,(IY+2)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37640"></a>37640</td>
<td class="instruction">XOR 24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="37642"></a>37642</td>
<td class="instruction">DJNZ <a class="link" href="37596.html#37624">37624</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37644"></a>37644</td>
<td class="instruction">DEC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37645"></a>37645</td>
<td class="instruction">JR NZ,<a class="link" href="37596.html#37624">37624</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37647"></a>37647</td>
<td class="instruction">CALL <a class="link" href="37687.html">37687</a></td>
<td class="comment-11" rowspan="1">Check whether ENTER or the fire button is being pressed</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37650"></a>37650</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return (with the zero flag reset) if it is</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37651"></a>37651</td>
<td class="instruction">LD A,(IY+1)</td>
<td class="comment-11" rowspan="1">Pick up the second byte of data for this note</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37654"></a>37654</td>
<td class="instruction">CALL <a class="link" href="37675.html">37675</a></td>
<td class="comment-11" rowspan="1">Calculate the attribute file address for the corresponding piano key</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37657"></a>37657</td>
<td class="instruction">LD (HL),56</td>
<td class="comment-11" rowspan="1">Set the attribute byte for the piano key back to 56 (INK 0: PAPER 7: BRIGHT 0)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37659"></a>37659</td>
<td class="instruction">LD A,(IY+2)</td>
<td class="comment-11" rowspan="1">Pick up the third byte of data for this note</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37662"></a>37662</td>
<td class="instruction">CALL <a class="link" href="37675.html">37675</a></td>
<td class="comment-11" rowspan="1">Calculate the attribute file address for the corresponding piano key</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37665"></a>37665</td>
<td class="instruction">LD (HL),56</td>
<td class="comment-11" rowspan="1">Set the attribute byte for the piano key back to 56 (INK 0: PAPER 7: BRIGHT 0)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37667"></a>37667</td>
<td class="instruction">INC IY</td>
<td class="comment-11" rowspan="3">Move <span class="register">IY</span> along to the data for the next note in the tune</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37669"></a>37669</td>
<td class="instruction">INC IY</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37671"></a>37671</td>
<td class="instruction">INC IY</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="37673"></a>37673</td>
<td class="instruction">JR <a class="link" href="37596.html#37596">37596</a></td>
<td class="comment-11" rowspan="1">Jump back to play the next note</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="37579.html">37579</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#37596">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="37675.html">37675</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Manic Miner RAM disassembly 20141114</div>
<div class="copyright">&#169; 1983 Bug-Byte Ltd (Manic Miner). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.1.1.</div>
</div>
</body>
</html>